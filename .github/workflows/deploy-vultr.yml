name: üöÄ Deploy to Vultr VPS

on:
  push:
    branches: [ "feature/migration" ]
  workflow_dispatch:  # Permet le d√©ploiement manuel

env:
  APP_PATH: /var/www/axontis
  PHP_VERSION: '8.3'
  NODE_VERSION: '22'

jobs:
  deploy:
    name: üöÄ Build & Deploy to Vultr
    runs-on: ubuntu-latest

    steps:
      # =========================================================================
      # 1. CHECKOUT & SETUP
      # =========================================================================
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, zip, bcmath, gd, pdo, pdo_mysql, fileinfo
          coverage: none

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # =========================================================================
      # 2. BUILD
      # =========================================================================
      - name: üîß Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist

      - name: üîß Install Node dependencies & Build assets
        run: |
          npm ci
          npm run build

      # =========================================================================
      # 3. CREATE RELEASE ARCHIVE
      # =========================================================================
      - name: üóÇÔ∏è Create release archive
        run: |
          set +e
          tar -czf release.tar.gz \
            --exclude='release.tar.gz' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='.env.production.example' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/data/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            .
          TAR_EXIT=$?
          set -e
          # Exit code 1 = "file changed as we read it" (warning, not error)
          # Exit code 2+ = actual error
          if [ $TAR_EXIT -ge 2 ]; then
            echo "‚ùå tar failed with exit code $TAR_EXIT"
            exit $TAR_EXIT
          fi
          echo "‚úÖ Archive created successfully"

      # =========================================================================
      # 4. SSH SETUP
      # =========================================================================
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VULTR_SSH_PRIVATE_KEY }}

      - name: üìã Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VULTR_HOST }} >> ~/.ssh/known_hosts

      - name: üîç Test SSH connection
        run: |
          echo "Testing SSH connection to ${{ secrets.VULTR_USER }}@${{ secrets.VULTR_HOST }}..."
          ssh -o BatchMode=yes -o ConnectTimeout=10 -v ${{ secrets.VULTR_USER }}@${{ secrets.VULTR_HOST }} "echo 'SSH connection successful'" || {
            echo "‚ùå SSH connection failed!"
            echo ""
            echo "Please ensure the following public key is added to ~/.ssh/authorized_keys on your Vultr server:"
            ssh-add -L
            exit 1
          }

      # =========================================================================
      # 5. UPLOAD TO SERVER
      # =========================================================================
      - name: üì§ Upload release to server
        run: |
          scp release.tar.gz ${{ secrets.VULTR_USER }}@${{ secrets.VULTR_HOST }}:/tmp/release.tar.gz

      # =========================================================================
      # 6. DEPLOY ON SERVER WITH SECRETS
      # =========================================================================
      - name: üöÄ Deploy on server
        env:
          # Database
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          # App
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_URL: ${{ secrets.APP_URL }}
          # Cloudflare R2
          CLOUDFLARE_R2_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
          CLOUDFLARE_R2_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
          CLOUDFLARE_R2_BUCKET: ${{ secrets.CLOUDFLARE_R2_BUCKET }}
          CLOUDFLARE_R2_ENDPOINT: ${{ secrets.CLOUDFLARE_R2_ENDPOINT }}
          CLOUDFLARE_R2_URL: ${{ secrets.CLOUDFLARE_R2_URL }}
          # DocuSign
          DOCUSIGN_CLIENT_ID: ${{ secrets.DOCUSIGN_CLIENT_ID }}
          DOCUSIGN_USER_ID: ${{ secrets.DOCUSIGN_USER_ID }}
          DOCUSIGN_ACCOUNT_ID: ${{ secrets.DOCUSIGN_ACCOUNT_ID }}
          DOCUSIGN_BASE_PATH: ${{ secrets.DOCUSIGN_BASE_PATH }}
          DOCUSIGN_OAUTH_BASE_PATH: ${{ secrets.DOCUSIGN_OAUTH_BASE_PATH }}
          DOCUSIGN_HMAC_KEY: ${{ secrets.DOCUSIGN_HMAC_KEY }}
          # Stripe
          STRIPE_PUBLIC_KEY: ${{ secrets.STRIPE_PUBLIC_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          # Sentry
          SENTRY_LARAVEL_DSN: ${{ secrets.SENTRY_LARAVEL_DSN }}
          # Mail
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_FROM_ADDRESS: ${{ secrets.MAIL_FROM_ADDRESS }}
        run: |
          ssh ${{ secrets.VULTR_USER }}@${{ secrets.VULTR_HOST }} \
          "export DB_HOST='$DB_HOST' \
          DB_PORT='$DB_PORT' \
          DB_DATABASE='$DB_DATABASE' \
          DB_USERNAME='$DB_USERNAME' \
          DB_PASSWORD='$DB_PASSWORD' \
          APP_KEY='$APP_KEY' \
          APP_URL='$APP_URL' \
          CLOUDFLARE_R2_ACCESS_KEY_ID='$CLOUDFLARE_R2_ACCESS_KEY_ID' \
          CLOUDFLARE_R2_SECRET_ACCESS_KEY='$CLOUDFLARE_R2_SECRET_ACCESS_KEY' \
          CLOUDFLARE_R2_BUCKET='$CLOUDFLARE_R2_BUCKET' \
          CLOUDFLARE_R2_ENDPOINT='$CLOUDFLARE_R2_ENDPOINT' \
          CLOUDFLARE_R2_URL='$CLOUDFLARE_R2_URL' \
          DOCUSIGN_CLIENT_ID='$DOCUSIGN_CLIENT_ID' \
          DOCUSIGN_USER_ID='$DOCUSIGN_USER_ID' \
          DOCUSIGN_ACCOUNT_ID='$DOCUSIGN_ACCOUNT_ID' \
          DOCUSIGN_BASE_PATH='$DOCUSIGN_BASE_PATH' \
          DOCUSIGN_OAUTH_BASE_PATH='$DOCUSIGN_OAUTH_BASE_PATH' \
          DOCUSIGN_HMAC_KEY='$DOCUSIGN_HMAC_KEY' \
          STRIPE_PUBLIC_KEY='$STRIPE_PUBLIC_KEY' \
          STRIPE_SECRET_KEY='$STRIPE_SECRET_KEY' \
          STRIPE_WEBHOOK_SECRET='$STRIPE_WEBHOOK_SECRET' \
          SENTRY_LARAVEL_DSN='$SENTRY_LARAVEL_DSN' \
          MAIL_HOST='$MAIL_HOST' \
          MAIL_PORT='$MAIL_PORT' \
          MAIL_USERNAME='$MAIL_USERNAME' \
          MAIL_PASSWORD='$MAIL_PASSWORD' \
          MAIL_FROM_ADDRESS='$MAIL_FROM_ADDRESS'; /bin/bash" << 'DEPLOY_SCRIPT'
          set -e

          echo "=========================================="
          echo "üöÄ D√âPLOIEMENT AXONTIS - $(date)"
          echo "=========================================="

          APP_PATH="/var/www/axontis"
          BACKUP_PATH="/var/backups/axontis"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Cr√©er les dossiers n√©cessaires
          mkdir -p $BACKUP_PATH
          mkdir -p $APP_PATH

          # ============================================
          # 1. BACKUP DU CODE ACTUEL
          # ============================================
          echo "üì¶ Backup du code actuel..."
          if [ -d "$APP_PATH" ] && [ -f "$APP_PATH/artisan" ]; then
            tar -czf "$BACKUP_PATH/backup_${TIMESTAMP}.tar.gz" \
              -C /var/www axontis \
              --exclude='storage/logs/*' \
              --exclude='storage/framework/cache/*' \
              --exclude='vendor' \
              --exclude='node_modules' 2>/dev/null || true
            echo "‚úÖ Backup cr√©√©: backup_${TIMESTAMP}.tar.gz"

            # Garder seulement les 5 derniers backups
            cd $BACKUP_PATH && ls -t backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -- 2>/dev/null || true
          fi

          # ============================================
          # 2. MODE MAINTENANCE
          # ============================================
          echo "üîß Activation du mode maintenance..."
          cd $APP_PATH 2>/dev/null && php artisan down --retry=60 2>/dev/null || true

          # ============================================
          # 3. SAUVEGARDE DES FICHIERS IMPORTANTS
          # ============================================
          echo "üíæ Sauvegarde des fichiers persistants..."
          cp $APP_PATH/.env /tmp/.env.backup 2>/dev/null || true
          cp -r $APP_PATH/storage/app /tmp/storage_app_backup 2>/dev/null || true

          # ============================================
          # 4. EXTRACTION DU NOUVEAU CODE
          # ============================================
          echo "üì• Extraction du nouveau code..."
          cd $APP_PATH
          tar -xzf /tmp/release.tar.gz --overwrite
          rm -f /tmp/release.tar.gz
          echo "‚úÖ Code extrait"

          # ============================================
          # 5. CONFIGURATION DU .ENV
          # ============================================
          echo "‚öôÔ∏è Configuration de l'environnement..."

          # Si .env n'existe pas, le cr√©er depuis .env.example
          if [ ! -f "$APP_PATH/.env" ]; then
            if [ -f "$APP_PATH/.env.example" ]; then
              cp $APP_PATH/.env.example $APP_PATH/.env
              echo "‚úÖ .env cr√©√© depuis .env.example"
            else
              touch $APP_PATH/.env
              echo "‚úÖ .env vide cr√©√©"
            fi
          else
            # Restaurer le .env sauvegard√©
            cp /tmp/.env.backup $APP_PATH/.env 2>/dev/null || true
            echo "‚úÖ .env restaur√© depuis backup"
          fi

          # Fonction pour ajouter ou mettre √† jour une variable
          update_env() {
            local key=$1
            local value=$2
            if [ -n "$value" ]; then
              if grep -q "^${key}=" $APP_PATH/.env; then
                sed -i "s|^${key}=.*|${key}=${value}|" $APP_PATH/.env
              else
                echo "${key}=${value}" >> $APP_PATH/.env
              fi
            fi
          }

          # Configurer les variables d'application
          echo "=== APP CONFIGURATION ==="
          update_env "APP_ENV" "production"
          update_env "APP_DEBUG" "false"
          update_env "APP_KEY" "$APP_KEY"
          update_env "APP_URL" "$APP_URL"

          # Configurer la base de donn√©es
          echo "=== DATABASE CONFIGURATION ==="
          update_env "DB_CONNECTION" "mysql"
          update_env "DB_HOST" "$DB_HOST"
          update_env "DB_PORT" "$DB_PORT"
          update_env "DB_DATABASE" "$DB_DATABASE"
          update_env "DB_USERNAME" "$DB_USERNAME"
          update_env "DB_PASSWORD" "$DB_PASSWORD"
          echo "‚úÖ Database configuration updated"

          # Configurer Cloudflare R2
          echo "=== CLOUDFLARE R2 CONFIGURATION ==="
          update_env "CLOUDFLARE_R2_ACCESS_KEY_ID" "$CLOUDFLARE_R2_ACCESS_KEY_ID"
          update_env "CLOUDFLARE_R2_SECRET_ACCESS_KEY" "$CLOUDFLARE_R2_SECRET_ACCESS_KEY"
          update_env "CLOUDFLARE_R2_BUCKET" "$CLOUDFLARE_R2_BUCKET"
          update_env "CLOUDFLARE_R2_ENDPOINT" "$CLOUDFLARE_R2_ENDPOINT"
          update_env "CLOUDFLARE_R2_URL" "$CLOUDFLARE_R2_URL"
          echo "‚úÖ Cloudflare R2 configuration updated"

          # Configurer DocuSign
          echo "=== DOCUSIGN CONFIGURATION ==="
          update_env "DOCUSIGN_CLIENT_ID" "$DOCUSIGN_CLIENT_ID"
          update_env "DOCUSIGN_USER_ID" "$DOCUSIGN_USER_ID"
          update_env "DOCUSIGN_ACCOUNT_ID" "$DOCUSIGN_ACCOUNT_ID"
          update_env "DOCUSIGN_BASE_PATH" "$DOCUSIGN_BASE_PATH"
          update_env "DOCUSIGN_OAUTH_BASE_PATH" "$DOCUSIGN_OAUTH_BASE_PATH"
          update_env "DOCUSIGN_HMAC_KEY" "$DOCUSIGN_HMAC_KEY"
          echo "‚úÖ DocuSign configuration updated"

          # Configurer Stripe
          echo "=== STRIPE CONFIGURATION ==="
          update_env "STRIPE_PUBLIC_KEY" "$STRIPE_PUBLIC_KEY"
          update_env "STRIPE_SECRET_KEY" "$STRIPE_SECRET_KEY"
          update_env "STRIPE_WEBHOOK_SECRET" "$STRIPE_WEBHOOK_SECRET"
          echo "‚úÖ Stripe configuration updated"

          # Configurer Sentry
          echo "=== SENTRY CONFIGURATION ==="
          update_env "SENTRY_LARAVEL_DSN" "$SENTRY_LARAVEL_DSN"
          echo "‚úÖ Sentry configuration updated"

          # Configurer Mail
          echo "=== MAIL CONFIGURATION ==="
          update_env "MAIL_HOST" "$MAIL_HOST"
          update_env "MAIL_PORT" "$MAIL_PORT"
          update_env "MAIL_USERNAME" "$MAIL_USERNAME"
          update_env "MAIL_PASSWORD" "$MAIL_PASSWORD"
          update_env "MAIL_FROM_ADDRESS" "$MAIL_FROM_ADDRESS"
          echo "‚úÖ Mail configuration updated"

          # Configurer les queues et sessions pour Vultr
          update_env "QUEUE_CONNECTION" "database"
          update_env "SESSION_DRIVER" "database"
          update_env "CACHE_DRIVER" "file"

          # Debug: afficher les variables configur√©es (sans les valeurs sensibles)
          echo "=== .ENV VERIFICATION ==="
          echo "Variables defined in .env:"
          grep -E "^[A-Z_]+=" $APP_PATH/.env | cut -d'=' -f1 | sort
          echo ""

          # V√©rifier les variables critiques
          echo "=== CRITICAL VARIABLES CHECK ==="
          check_var() {
            if grep -q "^$1=.\+" $APP_PATH/.env; then
              echo "‚úÖ $1 is set"
            else
              echo "‚ö†Ô∏è $1 is EMPTY or missing"
            fi
          }
          check_var "APP_KEY"
          check_var "APP_URL"
          check_var "DB_HOST"
          check_var "DB_PORT"
          check_var "DB_DATABASE"
          check_var "DB_USERNAME"
          check_var "DB_PASSWORD"

          # ============================================
          # 6. RESTAURER LES FICHIERS PERSISTANTS
          # ============================================
          echo "üìÇ Restauration des fichiers upload√©s..."
          if [ -d "/tmp/storage_app_backup" ]; then
            cp -r /tmp/storage_app_backup/* $APP_PATH/storage/app/ 2>/dev/null || true
            rm -rf /tmp/storage_app_backup
          fi

          # ============================================
          # 7. INSTALLATION DES D√âPENDANCES
          # ============================================
          echo "üì¶ V√©rification des d√©pendances Composer..."
          cd $APP_PATH
          composer install --no-dev --optimize-autoloader --no-interaction

          # ============================================
          # 8. MIGRATIONS
          # ============================================
          echo "üóÑÔ∏è Ex√©cution des migrations..."
          php artisan migrate --force || echo "‚ö†Ô∏è Migration failed or no migrations"

          # ============================================
          # 9. OPTIMISATIONS LARAVEL
          # ============================================
          echo "‚ö° Optimisation de Laravel..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan event:cache

          # S'assurer que le lien storage existe
          php artisan storage:link 2>/dev/null || true

          # ============================================
          # 10. PERMISSIONS
          # ============================================
          echo "üîí Configuration des permissions..."
          chown -R www-data:www-data $APP_PATH
          chmod -R 755 $APP_PATH
          chmod -R 775 $APP_PATH/storage
          chmod -R 775 $APP_PATH/bootstrap/cache

          # ============================================
          # 11. RED√âMARRAGE DES SERVICES
          # ============================================
          echo "üîÑ Red√©marrage des services..."
          systemctl reload php8.3-fpm
          php artisan queue:restart
          supervisorctl restart axontis-worker:* 2>/dev/null || true

          # ============================================
          # 12. D√âSACTIVATION DU MODE MAINTENANCE
          # ============================================
          echo "‚úÖ D√©sactivation du mode maintenance..."
          php artisan up

          # ============================================
          # 13. V√âRIFICATION
          # ============================================
          echo "üîç V√©rification du d√©ploiement..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "‚úÖ Application accessible (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è L'application r√©pond avec HTTP $HTTP_CODE"
          fi

          echo ""
          echo "=========================================="
          echo "üéâ D√âPLOIEMENT TERMIN√â AVEC SUCC√àS!"
          echo "=========================================="

          DEPLOY_SCRIPT

  # =============================================================================
  # Job 2: Notify (optionnel)
  # =============================================================================
  notify:
    name: üì¢ Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: üìä Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ D√©ploiement r√©ussi sur Vultr VPS"
          else
            echo "‚ùå √âchec du d√©ploiement"
            exit 1
          fi
